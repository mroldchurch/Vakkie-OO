<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feyenoord 25/26 ‚Äì Aanwezigheid</title>
  <style>
    body { background: #fff; color: #000; font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; position: sticky; top: 0; z-index: 2; }
    input[type="text"] { width: 72px; text-align: center; padding: 4px; border-radius: 4px; border: 1px solid #aaa; }
    input[type="date"], input[type="time"] { padding: 4px; }
    .seat-head { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; font-size: 12px; }
    .legend { font-size: 14px; margin-bottom: 6px; }
    .legend code { background:#f5f5f5; padding:2px 6px; border:1px solid #ddd; border-radius:6px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
    button { border:1px solid #bbb; background:#f7f7f7; padding:8px 10px; border-radius:6px; cursor:pointer; }
    button:hover { background:#eee; }
    #saveStatus { font-size: 12px; color:#555; }
    input[type="file"] { display:none; }
    label.btn { border:1px solid #bbb; background:#f7f7f7; padding:8px 10px; border-radius:6px; cursor:pointer; }
    label.btn:hover { background:#eee; }
  </style>
</head>
<body>
  <h1>Feyenoord 25/26 ‚Äì Aanwezigheid (thuis + Europa)</h1>
  <p class="legend"><strong>Legenda:</strong>
    <code>z</code> = zelf (groen),
    <code>v</code> = vrij (grijs),
    <code>t</code> = exchange (rood),
    <code>vd</code> = verkocht aan derden (blauw) ‚Üí popup: <em>Aan wie?</em>
  </p>

  <div class="toolbar">
    <button id="exportCSV">‚¨áÔ∏è Export CSV</button>
    <button id="exportXLS">‚¨áÔ∏è Export Excel (.xls)</button>
    <label class="btn" for="importCSV">‚¨ÜÔ∏è Import CSV</label><input id="importCSV" type="file" accept=".csv" />
    <button id="clearAll">üóëÔ∏è Alles wissen</button>
    <span id="saveStatus">Nog niet opgeslagen</span>
  </div>

  <table id="grid">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>

  <template id="matchRow">
    <tr>
      <td><input type="date" class="date"/></td>
      <td><input type="time" class="time"/></td>
      <td><input type="text" class="opp" placeholder="Tegenstander"/></td>
      <td class="titleCol"></td>
    </tr>
  </template>

  <script>
    const KEY = 'fey25_white_vd_autosave_clean_v1';

    const initial = {
      seats: ["5-60 Luca","5-61 Milan","5-62 Dennis","6-58 Noel","6-59 Xavi","6-60 Ren√©","6-61 Kevin","6-62 Jan"],
      rows: [
        // Eredivisie ‚Äì Thuis (tijden deels T.B.D.)
        {date:'2025-09-13', time:'21:00', opp:'SC Heerenveen', cells:{}},
        {date:'2025-09-17', time:'20:00', opp:'Fortuna Sittard', cells:{}},
        {date:'2025-10-05', time:'',     opp:'FC Utrecht', cells:{}},
        {date:'2025-10-26', time:'',     opp:'PSV', cells:{}},
        {date:'2025-11-01', time:'',     opp:'FC Volendam', cells:{}},
        {date:'2025-11-22', time:'',     opp:'N.E.C.', cells:{}},
        {date:'2025-12-06', time:'',     opp:'PEC Zwolle', cells:{}},
        {date:'2025-12-20', time:'',     opp:'FC Twente', cells:{}},
        {date:'2026-01-17', time:'',     opp:'Sparta Rotterdam', cells:{}},
        {date:'2026-01-24', time:'',     opp:'Heracles Almelo', cells:{}},
        {date:'2026-02-14', time:'',     opp:'Go Ahead Eagles', cells:{}},
        {date:'2026-02-21', time:'',     opp:'Telstar', cells:{}},
        {date:'2026-03-14', time:'',     opp:'Excelsior', cells:{}},
        {date:'2026-03-21', time:'',     opp:'Ajax', cells:{}},
        {date:'2026-04-23', time:'',     opp:'FC Groningen', cells:{}},
        {date:'2026-05-10', time:'',     opp:'AZ', cells:{}},
        // Europa League ‚Äì THUIS (met tijden)
        {date:'2025-10-02', time:'21:00', opp:'Aston Villa', cells:{}},
        {date:'2025-10-23', time:'18:45', opp:'Panathinaikos', cells:{}},
        {date:'2025-11-27', time:'18:45', opp:'Celtic', cells:{}},
        {date:'2026-01-22', time:'18:45', opp:'Sturm Graz', cells:{}},
      ]
    };

    let state = loadState() || structuredClone(initial);

    function loadState(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }
    function saveState(){
      try{
        localStorage.setItem(KEY, JSON.stringify(state));
        const dt = new Date().toLocaleString('nl-NL');
        document.getElementById('saveStatus').textContent = 'Laatst opgeslagen: ' + dt;
      }catch(e){
        document.getElementById('saveStatus').textContent = 'Opslaan mislukt (browser-blokkade?)';
      }
    }

    // Build table
    function render() {
      const thead = document.getElementById('thead');
      const tbody = document.getElementById('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';

      // Header row
      const trH = document.createElement('tr');
      ['Datum','Tijd','Tegenstander','Titel'].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        trH.appendChild(th);
      });
      state.seats.forEach(name => {
        const th = document.createElement('th');
        const d = document.createElement('div');
        d.className = 'seat-head';
        d.textContent = name;
        th.appendChild(d);
        trH.appendChild(th);
      });
      thead.appendChild(trH);

      // Sort rows chronologically
      const rowsSorted = state.rows.slice().sort((a,b)=>(a.date||'').localeCompare(b.date||''));

      // Rows
      rowsSorted.forEach(r => {
        const tr = document.querySelector('#matchRow').content.firstElementChild.cloneNode(true);
        const dI = tr.querySelector('.date'); dI.value = r.date || '';
        const tI = tr.querySelector('.time'); tI.value = r.time || '';
        const oI = tr.querySelector('.opp');  oI.value = r.opp  || '';
        tr.querySelector('.titleCol').textContent = `FEY ‚Äì ${r.opp} ‚Ä¢ ${r.time||'TBD'}`;

        // Save handlers for base fields
        dI.addEventListener('change', (e)=>{ r.date = e.target.value; tr.querySelector('.titleCol').textContent = `FEY ‚Äì ${r.opp} ‚Ä¢ ${r.time||'TBD'}`; saveState(); });
        tI.addEventListener('change', (e)=>{ r.time = e.target.value; tr.querySelector('.titleCol').textContent = `FEY ‚Äì ${r.opp} ‚Ä¢ ${r.time||'TBD'}`; saveState(); });
        oI.addEventListener('input', (e)=>{ r.opp  = e.target.value; tr.querySelector('.titleCol').textContent = `FEY ‚Äì ${r.opp} ‚Ä¢ ${r.time||'TBD'}`; saveState(); });

        state.seats.forEach(seat => {
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.type = 'text';
          inp.placeholder = 'z / v / t / vd';
          inp.maxLength = 24;
          inp.style.width = '78px';
          inp.style.textAlign = 'center';
          if(!r.cells) r.cells = {};
          inp.value = r.cells[seat] || '';
          inp.title = '';
          colorize(inp);
          inp.onblur = () => { maybeAskNote(inp, r, seat); };
          inp.oninput = (e) => { r.cells[seat] = e.target.value; colorize(inp); saveState(); };
          td.appendChild(inp);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    // Prompt for 'vd:' and save
    function maybeAskNote(inp, r, seat){
      const raw = (inp.value || '').trim().toLowerCase();
      if(raw === 'vd' || raw.startsWith('vd:')){
        let current = '';
        if(raw.startsWith('vd:')) current = inp.value.split(':').slice(1).join(':').trim();
        const aanWie = prompt('Aan wie verkocht? (naam/relatie)', current) || '';
        if(aanWie){
          inp.value = 'vd: ' + aanWie;
          inp.title = 'Verkocht aan derden: ' + aanWie;
        } else {
          inp.value = 'vd';
          inp.title = 'Verkocht aan derden';
        }
        r.cells[seat] = inp.value;
        colorize(inp);
        saveState();
      }
    }

    // Color coding
    function colorize(inp) {
      const val = (inp.value || '').trim().toLowerCase();
      inp.style.background = '#fff';
      inp.style.color = '#000';
      if(val === 'z') { inp.style.background = '#c6f6d5'; }             // groen
      else if(val === 'v') { inp.style.background = '#e5e7eb'; }        // grijs
      else if(val === 't' || val.startsWith('t.')) { inp.style.background = '#fecaca'; } // rood
      else if(val === 'vd' || val.startsWith('vd:')) { inp.style.background = '#bfdbfe'; } // blauw
    }

    // CSV export
    document.getElementById('exportCSV').addEventListener('click', ()=>{
      const headers = Array.from(document.querySelectorAll('#thead th')).map(th=>th.textContent);
      const rows = [];
      document.querySelectorAll('#tbody tr').forEach(tr=>{
        const cols = Array.from(tr.querySelectorAll('td')).map((td,i)=>{
          if(i===0) return td.querySelector('.date')?.value || '';
          if(i===1) return td.querySelector('.time')?.value || '';
          if(i===2) return td.querySelector('.opp')?.value || '';
          if(i===3) return td.querySelector('.titleCol')?.textContent || '';
          const v = td.querySelector('input')?.value || '';
          return v.replace(/"/g,'""');
        });
        rows.push(cols);
      });
      const csv = [headers.map(h=>`"${h}"`).join(',')].concat(
        rows.map(r=>r.map(c=>`"${c}"`).join(','))
      ).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
      a.download = 'Fey25-26-aanwezigheid.csv';
      a.click();
    });

    // Excel (.xls) export via HTML table
    document.getElementById('exportXLS').addEventListener('click', ()=>{
      // Build a pure HTML table snapshot (replace inputs with their values)
      const table = document.createElement('table');
      table.border = 1;
      // Header
      const trH = document.createElement('tr');
      Array.from(document.querySelectorAll('#thead th')).forEach(th=>{
        const th2 = document.createElement('th');
        th2.textContent = th.textContent;
        trH.appendChild(th2);
      });
      table.appendChild(trH);
      // Body
      document.querySelectorAll('#tbody tr').forEach(tr=>{
        const tr2 = document.createElement('tr');
        const tds = tr.querySelectorAll('td');
        // Datum, Tijd, Tegenstander, Titel
        const d = document.createElement('td'); d.textContent = tds[0].querySelector('.date')?.value || ''; tr2.appendChild(d);
        const ti = document.createElement('td'); ti.textContent = tds[1].querySelector('.time')?.value || ''; tr2.appendChild(ti);
        const op = document.createElement('td'); op.textContent = tds[2].querySelector('.opp')?.value || ''; tr2.appendChild(op);
        const tl = document.createElement('td'); tl.textContent = tds[3].querySelector('.titleCol')?.textContent || ''; tr2.appendChild(tl);
        for(let i=4;i<tds.length;i++){ const td = document.createElement('td'); td.textContent = tds[i].querySelector('input')?.value || ''; tr2.appendChild(td); }
        table.appendChild(tr2);
      });
      const html = '<html><head><meta charset="utf-8"></head><body>' + table.outerHTML + '</body></html>';
      const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'Fey25-26-aanwezigheid.xls'; // Excel-compatible
      a.click();
    });

    // CSV import
    document.getElementById('importCSV').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (evt)=>{
        try{
          const text = String(evt.target.result);
          const lines = text.split(/\r?\n/).filter(x=>x.trim().length);
          if(lines.length < 2) return alert('CSV lijkt leeg');
          const hdr = splitCSV(lines[0]);
          const base = ['Datum','Tijd','Tegenstander','Titel'];
          const seatCols = hdr.slice(base.length);
          const rows = [];
          for(let i=1;i<lines.length;i++){
            const cols = splitCSV(lines[i]);
            const r = {date:cols[0]||'', time:cols[1]||'', opp:cols[2]||'', cells:{}};
            seatCols.forEach((seat,idx)=>{ r.cells[seat] = cols[base.length+idx]||''; });
            rows.push(r);
          }
          state.seats = seatCols.length ? seatCols : state.seats;
          state.rows = rows;
          saveState();
          render();
          alert('CSV ge√Ømporteerd.');
        }catch(err){
          alert('Import mislukt: '+err);
        }
      };
      reader.readAsText(file);
    });

    function splitCSV(line){
      const out=[]; let cur=''; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){
          if(q && line[i+1]==='"'){ cur+='"'; i++; }
          else q=!q;
        }else if(ch===',' && !q){ out.push(cur); cur=''; }
        else cur+=ch;
      }
      out.push(cur); return out;
    }

    // Clear all saved data
    document.getElementById('clearAll').addEventListener('click', ()=>{
      if(!confirm('Weet je zeker dat je ALLES wilt wissen?')) return;
      localStorage.removeItem(KEY);
      state = structuredClone(initial);
      document.getElementById('saveStatus').textContent = 'Leeg gemaakt';
      render();
      saveState();
    });

    // First render & show last saved
    render();
    if(loadState()){
      document.getElementById('saveStatus').textContent = 'Gegevens geladen uit opslag';
    } else {
      document.getElementById('saveStatus').textContent = 'Nog niet opgeslagen';
    }
  </script>
</body>
</html>
